<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.hoshinohome.model.dao.HouseDealDao">

  <!-- ResultMap for HouseDealVo -->
  <resultMap id="HouseDealVoResultMap" type="com.ssafy.hoshinohome.model.vo.HouseDealVo">
    <result property="deal_code" column="deal_code" />
    <result property="deal_amount" column="deal_amount" />
    <result property="deal_year" column="deal_year" />
    <result property="deal_month" column="deal_month" />
    <result property="deal_day" column="deal_day" />
    <result property="area" column="area" />
    <result property="floor" column="floor" />
    <result property="apt_code" column="apt_code" />
    <result property="apartment_name" column="apartment_name" />
    <result property="lng" column="lng" />
    <result property="lat" column="lat" />
    <result property="address" column="address" />
  </resultMap>

  <!-- ResultMap for HouseDeal -->
  <resultMap id="HouseDealResultMap" type="com.ssafy.hoshinohome.model.dto.HouseDeal">
    <result property="deal_code" column="deal_code" />
    <result property="deal_amount" column="deal_amount" />
    <result property="deal_year" column="deal_year" />
    <result property="deal_month" column="deal_month" />
    <result property="deal_day" column="deal_day" />
    <result property="area" column="area" />
    <result property="floor" column="floor" />
    <result property="apt_code" column="apt_code" />
  </resultMap>

  <!-- Query for selectHouseDealLocations using resultMap -->
  <select id="selectHouseDealLocations" resultMap="HouseDealVoResultMap"> WITH filteredHouseInfo AS
    ( SELECT apt_code, apartment_name, lng, lat FROM houseinfo WHERE lng BETWEEN #{lngFrom} AND
    #{lngTo} AND lat BETWEEN #{latFrom} AND #{latTo} ORDER BY apt_code LIMIT 10 ) SELECT ranked.*
    FROM ( SELECT hd.deal_code, hd.deal_amount, hd.deal_year, hd.deal_month, hd.deal_day, hd.area,
    hd.floor, hd.apt_code, hi.apartment_name, hi.lng, hi.lat, ROW_NUMBER() OVER (PARTITION BY
    hd.apt_code ORDER BY hd.deal_code DESC) AS row_num FROM housedeal hd INNER JOIN
    filteredHouseInfo hi ON hd.apt_code = hi.apt_code ) ranked WHERE ranked.row_num = 1; </select>

  <!-- Query for selectHouseDeals using resultMap -->
  <select id="selectHouseDeals" resultMap="HouseDealResultMap"> SELECT * FROM housedeal WHERE
    apt_code = #{aptCode}; </select>

</mapper>